<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>符号扩展的实现方式</title>
<meta name="author" content="dirtysalt" />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="/themes/favicon.ico" /><link rel="stylesheet" type="text/css" href="/themes/simple.css"/></head>
<body>
<div id="content" class="content">
<h1 class="title">符号扩展的实现方式</h1>
<p>
最近在看一些代码，里面要实现 “长度截断 + 符号扩展”，自带实现是下面这样的
</p>

<div class="org-src-container">
<pre class="src src-Cpp">#define SEXT(x, len) ({ struct { int64_t n : len; } __x = { .n = x }; (int64_t)__x.n; })
</pre>
</div>

<p>
但是这个东西只对于编译期长度固定的情况有效，对于运行期则大约需要使用bit操作比如下面这样
</p>

<div class="org-src-container">
<pre class="src src-Cpp">#define SIGNEX(v, sb) ((v) | (((v) &amp; ((uint64_t)1 &lt;&lt; (sb))) ? ~(((uint64_t)1 &lt;&lt; (sb)) - 1) : 0))
</pre>
</div>

<p>
上面这种实现方式非常巧妙：
</p>
<ul class="org-ul">
<li>前面一个部分负责 [0,sb-1] 这个范围的bits</li>
<li>后面一个部分负责 [sb,63] 这个范围的bits</li>
</ul>

<p>
如果bits超过64也是可以的，因为 `((uint64_t)1 &lt;&lt; sb)` 会回绕过来(或者是&gt;&gt;)，这个非常有趣。我这里做了一个验证。
</p>
<div class="org-src-container">
<pre class="src src-Cpp">
int main() {
    for (int i = 0; i &lt; 32; i++) {
        uint64_t a = (uint64_t)1 &lt;&lt; (i);
        uint64_t b = (uint64_t)1 &lt;&lt; (i + 64);
        printf("a = 0x%llx, b = 0x%llx\n", a, b);
        assert(a == b);
    }
    for (int i = 0; i &lt; 32; i++) {
        uint64_t a = (uint64_t)0x8000000000000000 &gt;&gt; (i);
        uint64_t b = (uint64_t)0x8000000000000000 &gt;&gt; (i + 64);
        printf("a = 0x%llx, b = 0x%llx\n", a, b);
        assert(a == b);
    }
}

</pre>
</div>

<hr />

<p>
我这里想了另外一个实现方式，思路就是完全使用指令本身的符号扩展功能：
</p>
<ul class="org-ul">
<li>现将这个数左移到64位最高位</li>
<li>然后算术右移回来，那么就自动实现了符号扩展</li>
<li>在这个思路上也可以实现零扩展(zero-extended)</li>
</ul>

<div class="org-src-container">
<pre class="src src-Cpp">uint64_t signext(uint64_t value, int width) {
    int shift = (sizeof(uint64_t) - width) * 8;
    int64_t ans = ((int64_t)value &lt;&lt; shift) &gt;&gt; shift;
    return ans;
}
uint64_t zeroext(uint64_t value, int width) {
    int shift = (sizeof(uint64_t) - width) * 8;
    return (value &lt;&lt; shift) &gt;&gt; shift;
}
uint64_t zeroext2(uint64_t value, int width) {
    uint64_t mask = (1ULL &lt;&lt; mask) - 1;
    return value &amp; mask;
}
</pre>
</div>

<p>
可以简单地验证下
</p>

<div class="org-src-container">
<pre class="src src-Cpp">

int main() {
    struct Case {
        uint64_t value;
        int width;
        uint64_t exp;
    } cases[] = {
            {0x0ff, 1, (uint64_t)-1},
            {0x07f, 1, 0x07f},
            {0, 0, 0},
    };
    for (int i = 0; cases[i].value; i++) {
        uint64_t ans = signext(cases[i].value, cases[i].width);
        printf("case %d, ans = 0x%llx, exp = 0x%llx\n", i, ans, cases[i].exp);
        ans = signext(cases[i].value, cases[i].width + 64);
        printf("case %d, width + 64, ans = 0x%llx, exp = 0x%llx\n", i, ans, cases[i].exp);
        assert(ans == cases[i].exp);
        uint64_t zext = zeroext(cases[i].value, cases[i].width);
        assert(zext == cases[i].value);
        uint64_t zext2 = zeroext2(cases[i].value, cases[i].width);
        assert(zext2 == cases[i].value);

    }
}
</pre>
</div>
</div>
<div id="content"><!-- DISQUS BEGIN --><div id="disqus_thread"></div><script>/***  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/var disqus_config = function () {this.page.url = 'https://dirtysalt.github.io/html/how-to-sign-extend.html';this.page.identifier = 'how-to-sign-extend.html';};(function() {var d = document, s = d.createElement('script');s.src = 'https://dirlt.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><!-- DISQUS END --></div></body>
</html>
