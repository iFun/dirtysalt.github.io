<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HashTable性能测试(CK/phmap/ska)</title>
<meta name="author" content="dirtysalt" />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="/themes/favicon.ico" /><link rel="stylesheet" type="text/css" href="/themes/simple.css"/></head>
<body>
<div id="content" class="content">
<h1 class="title">HashTable性能测试(CK/phmap/ska)</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org2d1c7d9">1. 测试准备</a></li>
<li><a href="#orgf73e506">2. 低基数</a></li>
<li><a href="#org06d2cd9">3. 中基数</a></li>
<li><a href="#org377a887">4. 高基数</a></li>
<li><a href="#org0231a09">5. 超高基数</a></li>
<li><a href="#org4ed7454">6. CK和phmap对比</a></li>
<li><a href="#orga7c7741">7. 测试代码</a></li>
</ul>
</div>
</div>

<div id="outline-container-org2d1c7d9" class="outline-2">
<h2 id="org2d1c7d9"><span class="section-number-2">1.</span> 测试准备</h2>
<div class="outline-text-2" id="text-1">
<p>
CK代码是从 <a href="https://github.com/ClickHouse/ClickHouse/commit/2805c28e6573fab09128b43150c4a7cb7ad21cc1">https://github.com/ClickHouse/ClickHouse/commit/2805c28e6573fab09128b43150c4a7cb7ad21cc1</a> 上面分离出来的，为了方便地单独编译做了下面这些处理：
</p>
<ol class="org-ol">
<li>去掉了Key=Slice的情况，因为这个涉及到Arena和内存管理等东西</li>
<li>去掉了许多可能出现Exception的情况，假设这些情况都不会出现</li>
<li>保留了Allocator这段逻辑，CK在内存分配上有不少tricks可以学习</li>
</ol>

<p>
ska::flat_hash_map 源代码地址是在这里 <a href="https://github.com/skarupke/flat_hash_map/blob/master/flat_hash_map.hpp">https://github.com/skarupke/flat_hash_map/blob/master/flat_hash_map.hpp</a>
</p>

<p>
全部代码放在附件里面，测试代码放在文章最后，测试用例是这样的：
</p>

<p>
单机单线程，插入 65536000 行，然后基数情况如下，都是插入随机数
</p>
<ul class="org-ul">
<li>[A] 960，低基数</li>
<li>[B] 96000，中基数</li>
<li>[C] 9600000，高基数</li>
<li>[D] 960000000，超高基数</li>
</ul>

<p>
其中
</p>
<ul class="org-ul">
<li>run_insert_random 表示phmap</li>
<li>run_insert_random_ska 表示ska hashmap</li>
<li>run_insert_precompute 表示phmap 预先计算hashvalue+prefetch</li>
<li>run_insert_random_ck 表示CK</li>
</ul>

<pre class="example" id="orgf18db2e">
-----------------------------------------------------------------------------------
Benchmark                                         Time             CPU   Iterations
-----------------------------------------------------------------------------------
run_insert_random/65536000/960            219113702 ns    219081575 ns            3
run_insert_random_ska/65536000/960        304808498 ns    304779963 ns            2
run_insert_precompute/65536000/960        234825202 ns    234803423 ns            3
run_insert_random_ck/65536000/960         350274672 ns    350239037 ns            2
run_insert_random/65536000/96000          322532514 ns    322502376 ns            2
run_insert_random_ska/65536000/96000      906551339 ns    906459594 ns            1
run_insert_precompute/65536000/96000      270961498 ns    270920370 ns            3
run_insert_random_ck/65536000/96000       544284025 ns    544221843 ns            1
run_insert_random/65536000/9600000       2223202526 ns   2222753516 ns            1
run_insert_random_ska/65536000/9600000   2044231505 ns   2044013964 ns            1
run_insert_precompute/65536000/9600000   1086953992 ns   1086852808 ns            1
run_insert_random_ck/65536000/9600000    2099581536 ns   2099340097 ns            1
run_insert_random/65536000/960000000     6454115631 ns   6453461530 ns            1
run_insert_random_ska/65536000/960000000 6683883384 ns   6682989324 ns            1
run_insert_precompute/65536000/960000000 3963008998 ns   3962379163 ns            1
run_insert_random_ck/65536000/960000000  3743974165 ns   3743242838 ns            1
</pre>
</div>
</div>

<div id="outline-container-orgf73e506" class="outline-2">
<h2 id="orgf73e506"><span class="section-number-2">2.</span> 低基数</h2>
<div class="outline-text-2" id="text-2">
<p>
时间上看：
</p>
<ol class="org-ol">
<li>phmap性能是最好的</li>
<li>预取会略微有点负作用</li>
<li>CK效果并不好，可能CK针对低基数有优化</li>
</ol>

<p>
空间上看，CK有点低
</p>

<pre class="example" id="org3fba536">
run_insert_random/65536000/960            219113702 ns    219081575 ns            3
run_insert_random_ska/65536000/960        304808498 ns    304779963 ns            2
run_insert_precompute/65536000/960        234825202 ns    234803423 ns            3
run_insert_random_ck/65536000/960         350274672 ns    350239037 ns            2

run_insert_random: hash set size = 960, load factor = 0.468979
run_insert_random_ska: hash set size = 960, load factor = 0.46875
run_insert_precompute: hash set size = 960, load factor = 0.468979
run_insert_random_ck: hash set size = 960, load factor = 0.234375
</pre>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Hash Table</th>
<th scope="col" class="org-right">Time</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">phmap</td>
<td class="org-right">219113702</td>
</tr>

<tr>
<td class="org-left">ska</td>
<td class="org-right">304808498</td>
</tr>

<tr>
<td class="org-left">prefetch</td>
<td class="org-right">234825202</td>
</tr>

<tr>
<td class="org-left">ck</td>
<td class="org-right">350274672</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org06d2cd9" class="outline-2">
<h2 id="org06d2cd9"><span class="section-number-2">3.</span> 中基数</h2>
<div class="outline-text-2" id="text-3">
<p>
时间上看：
</p>
<ol class="org-ol">
<li>phmap依然是最好的</li>
<li>prefetch开始有效果</li>
<li>ska比较差</li>
</ol>

<p>
空间上看, ck/ska都比较低
</p>

<pre class="example" id="orge3011fc">
run_insert_random/65536000/96000          322532514 ns    322502376 ns            2
run_insert_random_ska/65536000/96000      906551339 ns    906459594 ns            1
run_insert_precompute/65536000/96000      270961498 ns    270920370 ns            3
run_insert_random_ck/65536000/96000       544284025 ns    544221843 ns            1

run_insert_random: hash set size = 96000, load factor = 0.732427
run_insert_random_ska: hash set size = 96000, load factor = 0.366211
run_insert_precompute: hash set size = 96000, load factor = 0.732427
run_insert_random_ck: hash set size = 96000, load factor = 0.366211
</pre>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Hash Table</th>
<th scope="col" class="org-right">Time</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">phmap</td>
<td class="org-right">322532514</td>
</tr>

<tr>
<td class="org-left">ska</td>
<td class="org-right">906551339</td>
</tr>

<tr>
<td class="org-left">prefetch</td>
<td class="org-right">270961498</td>
</tr>

<tr>
<td class="org-left">ck</td>
<td class="org-right">544284025</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org377a887" class="outline-2">
<h2 id="org377a887"><span class="section-number-2">4.</span> 高基数</h2>
<div class="outline-text-2" id="text-4">
<p>
时间上看：
</p>
<ul class="org-ul">
<li>此时CK/ska超过了phmap</li>
<li>但是prefetch效果非常明显</li>
</ul>

<p>
空间上看, ck/ska依然比较低
</p>

<pre class="example" id="org7a60502">
run_insert_random/65536000/9600000       2223202526 ns   2222753516 ns            1
run_insert_random_ska/65536000/9600000   2044231505 ns   2044013964 ns            1
run_insert_precompute/65536000/9600000   1086953992 ns   1086852808 ns            1
run_insert_random_ck/65536000/9600000    2099581536 ns   2099340097 ns            1

run_insert_random: hash set size = 9589629, load factor = 0.571586
run_insert_random_ska: hash set size = 9589629, load factor = 0.285793
run_insert_precompute: hash set size = 9589629, load factor = 0.571586
run_insert_random_ck: hash set size = 9589629, load factor = 0.285793
</pre>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Hash Table</th>
<th scope="col" class="org-right">Time</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">phmap</td>
<td class="org-right">2223202526</td>
</tr>

<tr>
<td class="org-left">ska</td>
<td class="org-right">2044231505</td>
</tr>

<tr>
<td class="org-left">prefetch</td>
<td class="org-right">1086953992</td>
</tr>

<tr>
<td class="org-left">ck</td>
<td class="org-right">2099581536</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org0231a09" class="outline-2">
<h2 id="org0231a09"><span class="section-number-2">5.</span> 超高基数</h2>
<div class="outline-text-2" id="text-5">
<p>
时间上看：
</p>
<ul class="org-ul">
<li>ck效果开始比较好</li>
<li>ska/phmap差不多</li>
<li>预取效果依然明显</li>
</ul>

<p>
空间上看，此时内存分配比较多，大家在在内存分配上都比较保守
</p>

<pre class="example" id="org77767d7">
run_insert_random/65536000/960000000     6454115631 ns   6453461530 ns            1
run_insert_random_ska/65536000/960000000 6683883384 ns   6682989324 ns            1
run_insert_precompute/65536000/960000000 3963008998 ns   3962379163 ns            1
run_insert_random_ck/65536000/960000000  3743974165 ns   3743242838 ns            1

run_insert_random: hash set size = 63273163, load factor = 0.471422
run_insert_random_ska: hash set size = 63273163, load factor = 0.471422
run_insert_precompute: hash set size = 63273163, load factor = 0.471422
run_insert_random_ck: hash set size = 63273163, load factor = 0.471422
</pre>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Hash Table</th>
<th scope="col" class="org-right">Time</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">phmap</td>
<td class="org-right">6454115631</td>
</tr>

<tr>
<td class="org-left">ska</td>
<td class="org-right">6683883384</td>
</tr>

<tr>
<td class="org-left">prefetch</td>
<td class="org-right">3963008998</td>
</tr>

<tr>
<td class="org-left">ck</td>
<td class="org-right">3743974165</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org4ed7454" class="outline-2">
<h2 id="org4ed7454"><span class="section-number-2">6.</span> CK和phmap对比</h2>
<div class="outline-text-2" id="text-6">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Card</th>
<th scope="col" class="org-right">Phmap</th>
<th scope="col" class="org-right">Phmap Prefetch</th>
<th scope="col" class="org-right">CK</th>
<th scope="col" class="org-right">Prefetch/CK</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Low</td>
<td class="org-right">219081575</td>
<td class="org-right">234803423</td>
<td class="org-right">350239037</td>
<td class="org-right">0.67</td>
</tr>

<tr>
<td class="org-left">Medium</td>
<td class="org-right">322502376</td>
<td class="org-right">270920370</td>
<td class="org-right">544221843</td>
<td class="org-right">0.498</td>
</tr>

<tr>
<td class="org-left">High</td>
<td class="org-right">2222753516</td>
<td class="org-right">1086852808</td>
<td class="org-right">2099340097</td>
<td class="org-right">0.518</td>
</tr>

<tr>
<td class="org-left">Ultra High</td>
<td class="org-right">6453461530</td>
<td class="org-right">3962379163</td>
<td class="org-right">3743242838</td>
<td class="org-right">1.059</td>
</tr>
</tbody>
</table>

<p>
可以发现，通过预先计算hash value加上prefetching技术，phmap可以在空间上做到低开销，同时在性能上超过（高基数情况）或者是与CK持平（超高基数情况）。
</p>


<div id="org9e31f56" class="figure">
<p><img src="../images/hashtable-perf-comparison.jpg" alt="hashtable-perf-comparison.jpg" />
</p>
</div>

<p>
另外下面两幅图是关于prefetch的基本知识：
</p>
<ol class="org-ol">
<li>自动prefetch是可行的（不管是CPU还是kernel），但是需要一定的数据量来训练。</li>
<li>训练出来的模式可以满足前向或者是后向，并且可以满足一定的访问间隔。</li>
</ol>


<div id="orga282024" class="figure">
<p><img src="../images/prefetchers-101.jpg" alt="prefetchers-101.jpg" />
</p>
</div>


<div id="org61d0d5a" class="figure">
<p><img src="../images/kernel-software-prefetching.jpg" alt="kernel-software-prefetching.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-orga7c7741" class="outline-2">
<h2 id="orga7c7741"><span class="section-number-2">7.</span> 测试代码</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">
<pre class="src src-Cpp">#include &lt;benchmark/benchmark.h&gt;
#include &lt;emmintrin.h&gt;
#include &lt;immintrin.h&gt;

#include &lt;cmath&gt;
#include &lt;cstdlib&gt;
#include &lt;functional&gt;
#include &lt;iostream&gt;

//#define PHMAP_LINEAR_PROBE
#include "Common/HashTable/HashSet.h"
#include "column/column_hash.h"
#include "column/hash_set.h"
#include "ska_flat_hash_map.hpp"
#include "util/phmap/phmap.h"

using namespace std;
using namespace starrocks::vectorized;
static constexpr size_t BLOCK = 4096;

void ConstructRandomSet(size_t size, size_t range, std::vector&lt;int&gt;&amp; rs) {
    rs.resize(size);
    std::srand(42);
    for (size_t i = 0; i &lt; size; i++) {
        rs[i] = std::rand() % range;
    }
}

class LogBuffer {
public:
    std::ostringstream&amp; buf() { return oss; }
    ~LogBuffer() { std::cerr &lt;&lt; oss.str(); }
private:
    std::ostringstream oss;
};

LogBuffer _log_buffer;

#define HSINFO(name) \
    _log_buffer.buf() &lt;&lt; name &lt;&lt; ": hash set size = " &lt;&lt; hs.size() &lt;&lt; ", load factor = " &lt;&lt; hs.load_factor() &lt;&lt; std::endl

static void run_insert_random(benchmark::State&amp; state) {
    // Code inside this loop is measured repeatedly
    std::vector&lt;int&gt; a;
    ConstructRandomSet(state.range(0), state.range(1), a);
    for (auto _ : state) {
        HashSet&lt;int&gt; hs;
        // state.PauseTiming();
        // state.ResumeTiming();
        for (size_t i = 0; i &lt; a.size(); i++) {
            hs.insert(a[i]);
        }
        HSINFO(__func__);
    }
}

static void run_insert_random_ska(benchmark::State&amp; state) {
    // Code inside this loop is measured repeatedly
    std::vector&lt;int&gt; a;
    ConstructRandomSet(state.range(0), state.range(1), a);

    for (auto _ : state) {
        ska::flat_hash_set&lt;int, StdHash&lt;int&gt;&gt; hs;
        // state.PauseTiming();
        // state.ResumeTiming();
        for (size_t i = 0; i &lt; a.size(); i++) {
            hs.insert(a[i]);
        }
        HSINFO(__func__);
    }
}

static void run_insert_sorted(benchmark::State&amp; state) {
    // Code inside this loop is measured repeatedly
    std::vector&lt;int&gt; a;
    ConstructRandomSet(state.range(0), state.range(1), a);
    std::sort(a.begin(), a.end());

    for (auto _ : state) {
        HashSet&lt;int&gt; hs;
        for (size_t i = 0; i &lt; a.size(); i++) {
            hs.insert(a[i]);
        }
        HSINFO(__func__);
    }
}

static void run_insert_precompute(benchmark::State&amp; state) {
    // Code inside this loop is measured repeatedly
    std::vector&lt;int&gt; a;
    ConstructRandomSet(state.range(0), state.range(1), a);

    static constexpr size_t PREFETCH = 16;
    std::vector&lt;size_t&gt; hash_values(BLOCK);

    for (auto _ : state) {
        HashSet&lt;int&gt; hs;
        const auto* data = a.data();
        const size_t size = a.size();

        for (size_t i = 0; i &lt; size; i += BLOCK) {
            for (size_t j = 0; j &lt; BLOCK; j++) {
                size_t hashval = hs.hash_function()(data[i + j]);
                hash_values[j] = hashval;
            }

            for (size_t j = 0, k = PREFETCH; j &lt; BLOCK; j++, k++) {
                if (k &lt; BLOCK) {
                    hs.prefetch_hash(hash_values[k]);
                }
                hs.emplace_with_hash(hash_values[j], data[i + j]);
            }
        }
        HSINFO(__func__);
    }
}

static void run_insert_random_ck(benchmark::State&amp; state) {
    // Code inside this loop is measured repeatedly
    std::vector&lt;int&gt; a;
    ConstructRandomSet(state.range(0), state.range(1), a);
    size_t set_size = 0;

    for (auto _ : state) {
        CK::HashSet&lt;int&gt; hs;
        // state.PauseTiming();
        // state.ResumeTiming();
        for (size_t i = 0; i &lt; a.size(); i++) {
            hs.insert(a[i]);
        }
        HSINFO(__func__);
    }
}

static const int FACTOR = 16;
static const int N = 4096000 * FACTOR;
static const int M0 = 60 * FACTOR;
static const int M1 = 6000 * FACTOR;
static const int M2 = 600000 * FACTOR;
static const int M3 = 60000000 * FACTOR;

static_assert(N % BLOCK == 0);

BENCHMARK(run_insert_random)-&gt;Args({N, M0});
BENCHMARK(run_insert_random_ska)-&gt;Args({N, M0});
BENCHMARK(run_insert_precompute)-&gt;Args({N, M0});
BENCHMARK(run_insert_random_ck)-&gt;Args({N, M0});

BENCHMARK(run_insert_random)-&gt;Args({N, M1});
BENCHMARK(run_insert_random_ska)-&gt;Args({N, M1});
BENCHMARK(run_insert_precompute)-&gt;Args({N, M1});
BENCHMARK(run_insert_random_ck)-&gt;Args({N, M1});

BENCHMARK(run_insert_random)-&gt;Args({N, M2});
BENCHMARK(run_insert_random_ska)-&gt;Args({N, M2});
BENCHMARK(run_insert_precompute)-&gt;Args({N, M2});
BENCHMARK(run_insert_random_ck)-&gt;Args({N, M2});

BENCHMARK(run_insert_random)-&gt;Args({N, M3});
BENCHMARK(run_insert_random_ska)-&gt;Args({N, M3});
BENCHMARK(run_insert_precompute)-&gt;Args({N, M3});
BENCHMARK(run_insert_random_ck)-&gt;Args({N, M3});
</pre>
</div>
</div>
</div>
</div>
<div id="content"><!-- DISQUS BEGIN --><div id="disqus_thread"></div><script>/***  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/var disqus_config = function () {this.page.url = 'https://dirtysalt.github.io/html/hashtable-perf-comparison.html';this.page.identifier = 'hashtable-perf-comparison.html';};(function() {var d = document, s = d.createElement('script');s.src = 'https://dirlt.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><!-- DISQUS END --></div></body>
</html>
