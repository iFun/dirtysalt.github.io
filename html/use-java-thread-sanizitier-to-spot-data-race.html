<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>使用Java ThreadSanitizer发现data race</title>
<meta name="author" content="dirtysalt" />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="/themes/favicon.ico" /><link rel="stylesheet" type="text/css" href="/themes/simple.css"/></head>
<body>
<div id="content" class="content">
<h1 class="title">使用Java ThreadSanitizer发现data race</h1>
<p>
这个功能我没有明白为什么没有加入默认的Java版本中，这个东西应该是很有用的东西。可能是效果不是特别好，也可能是存在某些明显的性能开销，以至于在代码中维护这些东西成本非常好而收益很低。
</p>

<p>
UPDATE: 效率是真的低，我感觉可能是10x-20x差不多左右。
</p>

<p>
<a href="https://runtimeverification.com/blog/detecting-popular-data-races-in-java-using-rv-predict/">https://runtimeverification.com/blog/detecting-popular-data-races-in-java-using-rv-predict/</a>
</p>

<hr />

<p>
openjdk/tsan: <a href="https://openjdk.org/projects/tsan">https://openjdk.org/projects/tsan</a>
</p>

<p>
编译命令是
</p>

<blockquote>
<p>
use-java13; unset CLASSPATH;  bash configure &#x2013;prefix=`pwd`/installed ; make CONF=linux-x86_64-server-release clean install
</p>
</blockquote>

<p>
简单的Java程序，多个线程共同修改某个变量
</p>

<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">package</span> com.starrocks.<span class="org-constant">lab</span>;

<span class="org-keyword">import</span> <span class="org-constant">java</span>.<span class="org-constant">util</span>.<span class="org-constant">concurrent</span>.<span class="org-type">ExecutorService</span>;
<span class="org-keyword">import</span> <span class="org-constant">java</span>.<span class="org-constant">util</span>.<span class="org-constant">concurrent</span>.<span class="org-type">Executors</span>;
<span class="org-keyword">import</span> <span class="org-constant">java</span>.<span class="org-constant">util</span>.<span class="org-constant">concurrent</span>.<span class="org-type">TimeUnit</span>;

<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">ThreadDataRaceCase</span> {
    <span class="org-type">int</span> <span class="org-variable-name">value</span>;

    <span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Adder</span> <span class="org-keyword">implements</span> <span class="org-type">Runnable</span> {
        <span class="org-type">int</span> <span class="org-variable-name">index</span>;
        <span class="org-type">int</span> <span class="org-variable-name">duration</span>;
        <span class="org-type">int</span> <span class="org-variable-name">tick</span>;

        <span class="org-keyword">public</span> Adder(<span class="org-type">int</span> <span class="org-variable-name">index</span>, <span class="org-type">int</span> <span class="org-variable-name">duration</span>) {
            <span class="org-keyword">this</span>.index = index;
            <span class="org-keyword">this</span>.duration = duration;
            <span class="org-keyword">this</span>.tick = 0;
        }

        <span class="org-c-annotation">@Override</span>
        <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">run</span>() {
            System.out.println(<span class="org-string">"Thread "</span> + index + <span class="org-string">" started..."</span>);
            <span class="org-type">long</span> <span class="org-variable-name">begin</span> = System.currentTimeMillis();
            <span class="org-keyword">while</span> (<span class="org-constant">true</span>) {
                value += 1;
                tick += 1;
                <span class="org-keyword">if</span> (tick % 100 == 0) {
                    <span class="org-type">long</span> <span class="org-variable-name">now</span> = System.currentTimeMillis();
                    <span class="org-keyword">if</span> ((now - begin) &gt; duration * 1000) {
                        <span class="org-keyword">break</span>;
                    }
                }
            }
            System.out.println(<span class="org-string">"Thread "</span> + index + <span class="org-string">" stopped..."</span>);
        }
    }

    <span class="org-keyword">public</span> <span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">main</span>(<span class="org-type">String</span>[] <span class="org-variable-name">args</span>) <span class="org-keyword">throws</span> <span class="org-type">InterruptedException</span> {
        <span class="org-type">ThreadDataRaceCase</span> <span class="org-variable-name">t</span> = <span class="org-keyword">new</span> <span class="org-type">ThreadDataRaceCase</span>();
        t.value = 0;

        <span class="org-type">int</span> <span class="org-variable-name">number</span> = 16;
        <span class="org-type">int</span> <span class="org-variable-name">duration</span> = 10;
        <span class="org-type">Adder</span> <span class="org-variable-name">adder</span>[] = <span class="org-keyword">new</span> <span class="org-type">Adder</span>[number];
        <span class="org-type">ExecutorService</span> <span class="org-variable-name">executor</span> = Executors.newFixedThreadPool(number);
        <span class="org-keyword">for</span> (<span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; <span class="org-type">number</span>; i++) {
            adder[i] = t.<span class="org-keyword">new</span> <span class="org-type">Adder</span>(i, duration);
            executor.submit(adder[i]);
        }

        executor.shutdown();
        executor.awaitTermination(2 * duration, <span class="org-constant">TimeUnit</span>.SECONDS);
    }
}
</pre>
</div>

<p>
运行起来可以发现错误是：需要使用 `java -XX:+ThreadSanitizer` 来运行
</p>

<pre class="example" id="org21cf8b9">
sandbox-cloud :: src/main/java ‹master*› » javac com/starrocks/lab/ThreadDataRaceCase.java
sandbox-cloud :: src/main/java ‹master*› » java -XX:+ThreadSanitizer com/starrocks/lab/ThreadDataRaceCase
Thread 1 started...
Thread 3 started...
==================
WARNING: ThreadSanitizer: data race (pid=227159)
  Read of size 4 at 0x000101c92a64 by thread T18:
    #0 com.starrocks.lab.ThreadDataRaceCase$Adder.run()V ThreadDataRaceCase.java:26
    #1 java.util.concurrent.Executors$RunnableAdapter.call()Ljava/lang/Object; Executors.java:515
    #2 java.util.concurrent.FutureTask.run()V FutureTask.java:264
    #3 java.util.concurrent.ThreadPoolExecutor.runWorker(Ljava/util/concurrent/ThreadPoolExecutor$Worker;)V ThreadPoolExecutor.java:1130
    #4 java.util.concurrent.ThreadPoolExecutor$Worker.run()V ThreadPoolExecutor.java:630
    #5 java.lang.Thread.run()V Thread.java:832
    #6 (Generated Stub) &lt;null&gt;

  Previous write of size 4 at 0x000101c92a64 by thread T16:
    #0 com.starrocks.lab.ThreadDataRaceCase$Adder.run()V ThreadDataRaceCase.java:26
    #1 java.util.concurrent.Executors$RunnableAdapter.call()Ljava/lang/Object; Executors.java:515
    #2 java.util.concurrent.FutureTask.run()V FutureTask.java:264
    #3 java.util.concurrent.ThreadPoolExecutor.runWorker(Ljava/util/concurrent/ThreadPoolExecutor$Worker;)V ThreadPoolExecutor.java:1130
    #4 java.util.concurrent.ThreadPoolExecutor$Worker.run()V ThreadPoolExecutor.java:630
    #5 java.lang.Thread.run()V Thread.java:832
    #6 (Generated Stub) &lt;null&gt;

  Thread T18 (tid=227178, running) created by thread T1 at:
    #0 pthread_create &lt;null&gt; (libtsan.so.0+0x615d8)
    #1 os::create_thread(Thread*, os::ThreadType, unsigned long) /home/disk4/zhangyan/repo/tsan/src/hotspot/os/linux/os_linux.cpp:927 (libjvm.so+0xb4e649)
    #2 java.lang.Thread.start()V Thread.java:801
    #3 java.util.concurrent.ThreadPoolExecutor.addWorker(Ljava/lang/Runnable;Z)Z ThreadPoolExecutor.java:939
    #4 java.util.concurrent.ThreadPoolExecutor.execute(Ljava/lang/Runnable;)V ThreadPoolExecutor.java:1345
    #5 java.util.concurrent.AbstractExecutorService.submit(Ljava/lang/Runnable;)Ljava/util/concurrent/Future; AbstractExecutorService.java:118
    #6 com.starrocks.lab.ThreadDataRaceCase.main([Ljava/lang/String;)V ThreadDataRaceCase.java:49
    #7 (Generated Stub) &lt;null&gt;

  Thread T16 (tid=227176, running) created by thread T1 at:
    #0 pthread_create &lt;null&gt; (libtsan.so.0+0x615d8)
    #1 os::create_thread(Thread*, os::ThreadType, unsigned long) /home/disk4/zhangyan/repo/tsan/src/hotspot/os/linux/os_linux.cpp:927 (libjvm.so+0xb4e649)
    #2 java.lang.Thread.start()V Thread.java:801
    #3 java.util.concurrent.ThreadPoolExecutor.addWorker(Ljava/lang/Runnable;Z)Z ThreadPoolExecutor.java:939
    #4 java.util.concurrent.ThreadPoolExecutor.execute(Ljava/lang/Runnable;)V ThreadPoolExecutor.java:1345
    #5 java.util.concurrent.AbstractExecutorService.submit(Ljava/lang/Runnable;)Ljava/util/concurrent/Future; AbstractExecutorService.java:118
    #6 com.starrocks.lab.ThreadDataRaceCase.main([Ljava/lang/String;)V ThreadDataRaceCase.java:49
    #7 (Generated Stub) &lt;null&gt;
</pre>
</div>
<div id="content"><!-- DISQUS BEGIN --><div id="disqus_thread"></div><script>/***  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/var disqus_config = function () {this.page.url = 'https://dirtysalt.github.io/html/use-java-thread-sanizitier-to-spot-data-race.html';this.page.identifier = 'use-java-thread-sanizitier-to-spot-data-race.html';};(function() {var d = document, s = d.createElement('script');s.src = 'https://dirlt.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><!-- DISQUS END --></div></body>
</html>
